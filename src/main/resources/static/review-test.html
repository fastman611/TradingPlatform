<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åŒåŸå¿«å§ - è¯„ä»·ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
            border-left: 5px solid #4299e1;
        }
        h2 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }
        .btn-primary {
            background: linear-gradient(to right, #4299e1, #38b2ac);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(66, 153, 225, 0.3);
        }
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        .btn-success {
            background: #48bb78;
            color: white;
        }
        .btn-success:hover {
            background: #38a169;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 600;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4299e1;
        }
        .result-box {
            margin-top: 15px;
            padding: 20px;
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 500px;
            overflow-y: auto;
        }
        .review-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
        }
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .review-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .review-rating {
            color: #f6ad55;
            font-size: 18px;
        }
        .review-content {
            margin: 15px 0;
            line-height: 1.6;
        }
        .review-images {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        .review-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
        }
        .review-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
            color: #718096;
            font-size: 14px;
        }
        .review-actions {
            display: flex;
            gap: 15px;
        }
        .stats-card {
            background: white;
            border: 2px solid #c6f6d5;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .average-rating {
            text-align: center;
        }
        .rating-number {
            font-size: 48px;
            font-weight: bold;
            color: #f6ad55;
        }
        .rating-stars {
            font-size: 20px;
            color: #f6ad55;
        }
        .rating-distribution {
            margin-top: 20px;
        }
        .distribution-bar {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .distribution-label {
            width: 60px;
            text-align: right;
            margin-right: 10px;
        }
        .distribution-bar-bg {
            flex: 1;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .distribution-bar-fill {
            height: 100%;
            background: #f6ad55;
            border-radius: 10px;
        }
        .distribution-count {
            width: 60px;
            text-align: left;
            margin-left: 10px;
        }
        .review-type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .type-product {
            background: #bee3f8;
            color: #2c5282;
        }
        .type-seller {
            background: #c6f6d5;
            color: #22543d;
        }
        .type-buyer {
            background: #fed7e2;
            color: #97266d;
        }
        .type-append {
            background: #e9d8fd;
            color: #553c9a;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>â­ åŒåŸå¿«å§äº¤æ˜“å¹³å° - è¯„ä»·ç³»ç»Ÿæµ‹è¯•</h1>
    <p class="subtitle">æµ‹è¯•å®Œæ•´çš„è¯„ä»·æµç¨‹ï¼šåˆ›å»ºè¯„ä»· â†’ æŸ¥çœ‹ç»Ÿè®¡ â†’ è¿½åŠ è¯„ä»· â†’ å›å¤è¯„ä»·</p>

    <!-- ç¬¬ä¸€æ­¥ï¼šè¯„ä»·ç±»å‹è¯´æ˜ -->
    <div class="test-section">
        <h2>ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šäº†è§£è¯„ä»·ç±»å‹</h2>
        <div class="btn-group">
            <button class="btn-secondary" onclick="getReviewTypes()">è·å–è¯„ä»·ç±»å‹</button>
        </div>
        <div id="reviewTypesInfo"></div>
    </div>

    <!-- ç¬¬äºŒæ­¥ï¼šåˆ›å»ºè¯„ä»· -->
    <div class="test-section">
        <h2>ğŸ“ ç¬¬äºŒæ­¥ï¼šåˆ›å»ºè¯„ä»·</h2>

        <div class="input-group">
            <label>è®¢å•IDï¼ˆå¿…é¡»æ˜¯å·²å®Œæˆçš„è®¢å•ï¼‰ï¼š</label>
            <input type="number" id="orderId" placeholder="è¾“å…¥è®¢å•ID" value="1">
        </div>

        <div class="input-group">
            <label>ä¹°å®¶IDï¼š</label>
            <input type="number" id="buyerId" placeholder="è¾“å…¥ä¹°å®¶ID" value="1">
        </div>

        <div class="input-group">
            <label>å•†å“IDï¼š</label>
            <input type="number" id="productId" placeholder="è¾“å…¥å•†å“ID" value="5">
        </div>

        <div class="input-group">
            <label>è¯„åˆ†ï¼ˆ1-5æ˜Ÿï¼‰ï¼š</label>
            <select id="rating">
                <option value="5">â˜…â˜…â˜…â˜…â˜… 5æ˜Ÿ - éå¸¸å¥½</option>
                <option value="4">â˜…â˜…â˜…â˜…â˜† 4æ˜Ÿ - å¾ˆå¥½</option>
                <option value="3">â˜…â˜…â˜…â˜†â˜† 3æ˜Ÿ - ä¸€èˆ¬</option>
                <option value="2">â˜…â˜…â˜†â˜†â˜† 2æ˜Ÿ - è¾ƒå·®</option>
                <option value="1">â˜…â˜†â˜†â˜†â˜† 1æ˜Ÿ - å¾ˆå·®</option>
            </select>
        </div>

        <div class="input-group">
            <label>è¯„ä»·å†…å®¹ï¼š</label>
            <textarea id="reviewContent" rows="3" placeholder="è¯·è¾“å…¥è¯„ä»·å†…å®¹...">å•†å“è´¨é‡å¾ˆå¥½ï¼Œå‘è´§é€Ÿåº¦å¿«ï¼Œéå¸¸æ»¡æ„ï¼</textarea>
        </div>

        <div class="input-group">
            <label>å›¾ç‰‡URLï¼ˆå¯é€‰ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰ï¼š</label>
            <input type="text" id="imageUrls" placeholder="ä¾‹å¦‚: /uploads/image1.jpg,/uploads/image2.jpg">
        </div>

        <div class="input-group">
            <label>
                <input type="checkbox" id="isAnonymous"> åŒ¿åè¯„ä»·
            </label>
        </div>

        <div class="btn-group">
            <button class="btn-primary" onclick="checkEligibility()">æ£€æŸ¥è¯„ä»·èµ„æ ¼</button>
            <button class="btn-success" onclick="createProductReview()">åˆ›å»ºå•†å“è¯„ä»·</button>
            <button class="btn-secondary" onclick="createBuyerReview()">å–å®¶è¯„ä»·ä¹°å®¶</button>
        </div>
    </div>

    <!-- ç¬¬ä¸‰æ­¥ï¼šæŸ¥çœ‹è¯„ä»· -->
    <div class="test-section">
        <h2>ğŸ‘€ ç¬¬ä¸‰æ­¥ï¼šæŸ¥çœ‹è¯„ä»·</h2>

        <div class="input-group">
            <label>å•†å“IDï¼ˆæŸ¥çœ‹å•†å“è¯„ä»·ï¼‰ï¼š</label>
            <input type="number" id="viewProductId" placeholder="è¾“å…¥å•†å“ID" value="5">
        </div>

        <div class="btn-group">
            <button class="btn-primary" onclick="getProductReviews()">è·å–å•†å“è¯„ä»·</button>
            <button class="btn-secondary" onclick="getProductReviewStats()">æŸ¥çœ‹è¯„ä»·ç»Ÿè®¡</button>
            <button class="btn-secondary" onclick="getHotReviews()">çƒ­é—¨è¯„ä»·</button>
            <button class="btn-secondary" onclick="getReviewsWithImages()">å¸¦å›¾è¯„ä»·</button>
        </div>

        <div id="productReviews"></div>
        <div id="reviewStats"></div>
    </div>

    <!-- ç¬¬å››æ­¥ï¼šè¯„ä»·ç®¡ç† -->
    <div class="test-section">
        <h2>ğŸ› ï¸ ç¬¬å››æ­¥ï¼šè¯„ä»·ç®¡ç†</h2>

        <div class="input-group">
            <label>è¯„ä»·IDï¼š</label>
            <input type="number" id="manageReviewId" placeholder="è¾“å…¥è¯„ä»·ID">
        </div>

        <div class="btn-group">
            <button class="btn-secondary" onclick="getReviewDetail()">æŸ¥çœ‹è¯„ä»·è¯¦æƒ…</button>
            <button class="btn-success" onclick="likeReview()">ç‚¹èµè¯„ä»·</button>
            <button class="btn-secondary" onclick="appendReview()">è¿½åŠ è¯„ä»·</button>
            <button class="btn-primary" onclick="replyToReview()">å›å¤è¯„ä»·</button>
            <button class="btn-danger" onclick="deleteReview()">åˆ é™¤è¯„ä»·</button>
        </div>
    </div>

    <!-- ç¬¬äº”æ­¥ï¼šæµ‹è¯•ç»“æœ -->
    <div class="test-section">
        <h2>ğŸ“Š ç¬¬äº”æ­¥ï¼šæµ‹è¯•ç»“æœ</h2>
        <div class="result-box" id="result">
            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•ï¼Œç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
        </div>
    </div>
</div>

<script>
    let lastResult = '';
    let currentReviewId = null;

    // æ˜¾ç¤ºç»“æœ
    function showResult(message, isError = false) {
        const resultDiv = document.getElementById('result');
        lastResult = typeof message === 'string' ? message : JSON.stringify(message, null, 2);

        if (typeof message !== 'string') {
            resultDiv.innerHTML = `<pre>${lastResult}</pre>`;
        } else {
            resultDiv.innerHTML = message;
        }

        // é«˜äº®æ˜¾ç¤ºé”™è¯¯
        if (isError) {
            resultDiv.style.border = '2px solid #f56565';
        } else {
            resultDiv.style.border = '2px solid #2d3748';
        }
    }

    // 1. è·å–è¯„ä»·ç±»å‹
    async function getReviewTypes() {
        try {
            const response = await fetch('/api/review/types');
            const data = await response.json();

            if (data.success) {
                let html = '<div class="stats-card">';
                html += '<h3>ğŸ“‹ è¯„ä»·ç±»å‹è¯´æ˜</h3>';

                data.types.forEach(type => {
                    html += `
                            <div class="review-card">
                                <div class="review-header">
                                    <div>
                                        <strong>${type.name}</strong>
                                        <span class="review-type-badge type-${type.code.toLowerCase().split('_')[0]}">${type.code}</span>
                                    </div>
                                </div>
                                <div class="review-content">${type.description}</div>
                            </div>
                        `;
                });

                html += '</div>';
                document.getElementById('reviewTypesInfo').innerHTML = html;

                showResult('è¯„ä»·ç±»å‹è·å–æˆåŠŸï¼š\n' + JSON.stringify(data.types, null, 2));
            } else {
                showResult('è·å–è¯„ä»·ç±»å‹å¤±è´¥ï¼š' + data.message, true);
            }
        } catch (error) {
            showResult('è·å–è¯„ä»·ç±»å‹å¤±è´¥ï¼š' + error.message, true);
        }
    }

    // 2. æ£€æŸ¥è¯„ä»·èµ„æ ¼
    async function checkEligibility() {
        const orderId = document.getElementById('orderId').value;
        const buyerId = document.getElementById('buyerId').value;

        if (!orderId || !buyerId) {
            alert('è¯·è¾“å…¥è®¢å•IDå’Œä¹°å®¶ID');
            return;
        }

        try {
            const response = await fetch(`/api/review/check-eligibility?orderId=${orderId}&userId=${buyerId}`);
            const data = await response.json();

            if (data.success) {
                const eligibility = data.eligibility;

                if (eligibility.eligible) {
                    showResult('âœ… å¯ä»¥è¯„ä»·ï¼\nè®¢å•ä¿¡æ¯ï¼š' + JSON.stringify(eligibility.order, null, 2));
                } else {
                    showResult('âŒ ä¸èƒ½è¯„ä»·ï¼š' + eligibility.reason, true);
                }
            } else {
                showResult('æ£€æŸ¥è¯„ä»·èµ„æ ¼å¤±è´¥ï¼š' + data.message, true);
            }
        } catch (error) {
            showResult('æ£€æŸ¥è¯„ä»·èµ„æ ¼å¤±è´¥ï¼š' + error.message, true);
        }
    }

    // 3. åˆ›å»ºå•†å“è¯„ä»·
    async function createProductReview() {
        const orderId = document.getElementById('orderId').value;
        const buyerId = document.getElementById('buyerId').value;
        const productId = document.getElementById('productId').value;
        const rating = document.getElementById('rating').value;
        const content = document.getElementById('reviewContent').value;
        const imageUrls = document.getElementById('imageUrls').value;
        const isAnonymous = document.getElementById('isAnonymous').checked;

        if (!orderId || !buyerId || !productId || !rating || !content) {
            alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
            return;
        }

        const imageUrlList = imageUrls ? imageUrls.split(',').map(url => url.trim()).filter(url => url) : [];

        try {
            const params = new URLSearchParams({
                orderId,
                buyerId,
                productId,
                rating,
                content,
                isAnonymous: isAnonymous.toString()
            });

            const url = `/api/review/product/create?${params.toString()}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: imageUrlList.length > 0 ? JSON.stringify(imageUrlList) : '[]'
            });

            const data = await response.json();

            if (data.success) {
                currentReviewId = data.review.id;
                document.getElementById('manageReviewId').value = currentReviewId;

                showResult('âœ… è¯„ä»·åˆ›å»ºæˆåŠŸï¼\nè¯„ä»·ä¿¡æ¯ï¼š' + JSON.stringify(data.review, null, 2));

                // è‡ªåŠ¨åˆ·æ–°è¯„ä»·åˆ—è¡¨
                setTimeout(() => getProductReviewStats(), 1000);
            } else {
                showResult('è¯„ä»·åˆ›å»ºå¤±è´¥ï¼š' + data.message, true);
            }
        } catch (error) {
            showResult('è¯„ä»·åˆ›å»ºå¤±è´¥ï¼š' + error.message, true);
        }
    }

    // 4. å–å®¶è¯„ä»·ä¹°å®¶
    async function createBuyerReview() {
        const orderId = document.getElementById('orderId').value;
        const buyerId = document.getElementById('buyerId').value;
        const sellerId = prompt('è¯·è¾“å…¥å–å®¶IDï¼š', '3');
        const rating = prompt('è¯·è¾“å…¥è¯„åˆ†ï¼ˆ1-5ï¼‰ï¼š', '5');
        const content = prompt('è¯·è¾“å…¥è¯„ä»·å†…å®¹ï¼š', 'ä¹°å®¶å¾ˆå¥½æ²Ÿé€šï¼Œäº¤æ˜“æ„‰å¿«ï¼');

        if (!orderId || !buyerId || !sellerId || !rating || !content) {
            alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
            return;
        }

        try {
            const response = await fetch(`/api/review/buyer/create?orderId=${orderId}&sellerId=${sellerId}&buyerId=${buyerId}&rating=${rating}&content=${encodeURIComponent(content)}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                showResult('âœ… ä¹°å®¶è¯„ä»·åˆ›å»ºæˆåŠŸï¼\nè¯„ä»·ä¿¡æ¯ï¼š' + JSON.stringify(data.review, null, 2));
            } else {
                showResult('ä¹°å®¶è¯„ä»·åˆ›å»ºå¤±è´¥ï¼š' + data.message, true);
            }
        } catch (error) {
            showResult('ä¹°å®¶è¯„ä»·åˆ›å»ºå¤±è´¥ï¼š' + error.message, true);
        }
    }

    // 5. è·å–å•†å“è¯„ä»·
    async function getProductReviews() {
        const productId = document.getElementById('viewProductId').value;

        if (!productId) {
            alert('è¯·è¾“å…¥å•†å“ID');
            return;
        }

        try {
            const response = await fetch(`/api/review/product/${productId}?page=0&size=10&sortBy=latest`);
            const data = await response.json();

            if (data.success) {
                displayProductReviews(data.reviews);
                showResult('è·å–å•†å“è¯„ä»·æˆåŠŸï¼Œå…± ' + data.reviews.length + ' æ¡');
            } else {
                showResult('è·å–å•†å“è¯„ä»·å¤±è´¥ï¼š' + data.message, true);
            }
        } catch (error) {
            showResult('è·å–å•†å“è¯„ä»·å¤±è´¥ï¼š' + error.message, true);
        }
    }

    // 6. æ˜¾ç¤ºå•†å“è¯„ä»·
    function displayProductReviews(reviews) {
        const container = document.getElementById('productReviews');

        if (!reviews || reviews.length === 0) {
            container.innerHTML = '<div class="review-card">æš‚æ— è¯„ä»·</div>';
            return;
        }

        let html = '<div class="stats-card">';
        html += `<h3>ğŸ“ å•†å“è¯„ä»·ï¼ˆ${reviews.length}æ¡ï¼‰</h3>`;

        reviews.forEach(review => {
            const typeClass = `type-${review.type.toLowerCase().split('_')[0]}`;
            const typeText = review.type === 'PRODUCT_REVIEW' ? 'å•†å“è¯„ä»·' :
                review.type === 'SELLER_REVIEW' ? 'å–å®¶è¯„ä»·' :
                    review.type === 'BUYER_REVIEW' ? 'ä¹°å®¶è¯„ä»·' : 'è¿½åŠ è¯„ä»·';

            let stars = '';
            for (let i = 0; i < 5; i++) {
                stars += i < review.rating ? 'â˜…' : 'â˜†';
            }

            let imagesHtml = '';
            if (review.imageUrls) {
                const images = review.imageUrls.split(',').filter(img => img);
                if (images.length > 0) {
                    imagesHtml = '<div class="review-images">';
                    images.forEach(img => {
                        imagesHtml += `<img src="${img}" class="review-image" onclick="window.open('${img}', '_blank')" title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾">`;
                    });
                    imagesHtml += '</div>';
                }
            }

            html += `
                    <div class="review-card">
                        <div class="review-header">
                            <div class="review-user">
                                <strong>${review.isAnonymous ? 'åŒ¿åç”¨æˆ·' : review.buyerName}</strong>
                                <span class="review-type-badge ${typeClass}">${typeText}</span>
                            </div>
                            <div class="review-rating" title="${review.rating}æ˜Ÿ">
                                ${stars}
                            </div>
                        </div>

                        <div class="review-content">
                            ${review.content || 'ï¼ˆæ— è¯„ä»·å†…å®¹ï¼‰'}
                        </div>

                        ${imagesHtml}

                        ${review.hasReply ? `
                            <div class="review-card" style="background: #f0fff4; margin-top: 10px;">
                                <div class="review-header">
                                    <strong>å–å®¶å›å¤ï¼š</strong>
                                </div>
                                <div class="review-content">${review.replyContent}</div>
                            </div>
                        ` : ''}

                        <div class="review-footer">
                            <div>
                                ${new Date(review.createTime).toLocaleString()}
                                ${review.replyCount > 0 ? ` Â· è¿½åŠ ${review.replyCount}æ¡` : ''}
                            </div>
                            <div class="review-actions">
                                <span>â¤ï¸ ${review.likeCount}</span>
                                <span>ğŸ‘ï¸ ${review.viewCount}</span>
                                <button onclick="setManageReviewId(${review.id})" style="background: #4299e1; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer;">ç®¡ç†</button>
                            </div>
                        </div>
                    </div>
                `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    // 7. è·å–è¯„ä»·ç»Ÿè®¡
    async function getProductReviewStats() {
        const productId = document.getElementById('viewProductId').value;

        if (!productId) {
            alert('è¯·è¾“å…¥å•†å“ID');
            return;
        }

        try {
            const response = await fetch(`/api/review/product/${productId}/stats`);
            const data = await response.json();

            if (data.success) {
                displayReviewStats(data.stats, data.ratingDistribution);
                showResult('è·å–è¯„ä»·ç»Ÿè®¡æˆåŠŸ');
            } else {
                showResult('è·å–è¯„ä»·ç»Ÿè®¡å¤±è´¥ï¼š' + data.message, true);
            }
        } catch (error) {
            showResult('è·å–è¯„ä»·ç»Ÿè®¡å¤±è´¥ï¼š' + error.message, true);
        }
    }

    // 8. æ˜¾ç¤ºè¯„ä»·ç»Ÿè®¡
    function displayReviewStats(stats, distribution) {
        const container = document.getElementById('reviewStats');

        let html = '<div class="stats-card">';
        html += '<div class="stats-header">';
        html += `<h3>ğŸ“Š è¯„ä»·ç»Ÿè®¡</h3>`;
        html += `<div>æ€»è¯„ä»·æ•°ï¼š<strong>${stats.totalReviews}</strong></div>`;
        html += '</div>';

        // å¹³å‡è¯„åˆ†
        html += `
                <div class="average-rating">
                    <div class="rating-number">${stats.averageRating.toFixed(1)}</div>
                    <div class="rating-stars">${getStars(stats.averageRating)}</div>
                    <div style="color: #718096; margin-top: 5px;">å¹³å‡è¯„åˆ†</div>
                </div>
            `;

        // è¯„åˆ†åˆ†å¸ƒ
        html += '<div class="rating-distribution">';
        html += '<h4>è¯„åˆ†åˆ†å¸ƒ</h4>';

        const total = stats.totalReviews || 1;
        for (let i = 5; i >= 1; i--) {
            const count = distribution[i] || 0;
            const percentage = Math.round((count / total) * 100);

            html += `
                    <div class="distribution-bar">
                        <div class="distribution-label">${i}æ˜Ÿ</div>
                        <div class="distribution-bar-bg">
                            <div class="distribution-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="distribution-count">${count} (${percentage}%)</div>
                    </div>
                `;
        }

        // å…¶ä»–ç»Ÿè®¡
        html += `
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #4299e1;">${stats.withImageCount}</div>
                            <div style="color: #718096; font-size: 12px;">å¸¦å›¾è¯„ä»·</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #48bb78;">${stats.appendCount}</div>
                            <div style="color: #718096; font-size: 12px;">è¿½åŠ è¯„ä»·</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #f6ad55;">${stats.replyCount}</div>
                            <div style="color: #718096; font-size: 12px;">å·²å›å¤</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #9f7aea;">${stats.totalReviews}</div>
                            <div style="color: #718096; font-size: 12px;">æ€»è®¡</div>
                        </div>
                    </div>
                </div>
            `;

        html += '</div></div>';
        container.innerHTML = html;
    }

    // 9. è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæ˜Ÿæ ‡
    function getStars(rating) {
        let stars = '';
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;

        for (let i = 0; i < fullStars; i++) stars += 'â˜…';
        if (hasHalfStar) stars += 'â˜†';
        for (let i = stars.length; i < 5; i++) stars += 'â˜†';

        return stars;
    }

    // 10. è®¾ç½®ç®¡ç†è¯„ä»·ID
    function setManageReviewId(reviewId) {
        document.getElementById('manageReviewId').value = reviewId;
        showResult(`å·²è®¾ç½®ç®¡ç†è¯„ä»·ID: ${reviewId}`);
    }

    // 11. è·å–è¯„ä»·è¯¦æƒ…
    async function getReviewDetail() {
        const reviewId = document.getElementById('manageReviewId').value;

        if (!reviewId) {
            alert('è¯·è¾“å…¥è¯„ä»·ID');
            return;
        }

        try {
            const response = await fetch(`/api/review/${reviewId}`);
            const data = await response.json();

            if (data.success) {
                showResult('è¯„ä»·è¯¦æƒ…ï¼š\n' + JSON.stringify(data.review, null, 2));
            } else {
                showResult('è·å–è¯„ä»·è¯¦æƒ…å¤±è´¥ï¼š' + data.message, true);
            }
        } catch (error) {
            showResult('è·å–è¯„ä»·è¯¦æƒ…å¤±è´¥ï¼š' + error.message, true);
        }
    }

    // 12. ç‚¹èµè¯„ä»·
    async function likeReview() {
        const reviewId = document.getElementById('manageReviewId').value;
        const userId = document.getElementById('buyerId').value || '1';

        if (!reviewId) {
            alert('è¯·è¾“å…¥è¯„ä»·ID');
            return;
        }

        try {
            const response = await fetch(`/api/review/${reviewId}/like?userId=${userId}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                showResult('âœ… ç‚¹èµæˆåŠŸï¼\næ›´æ–°åçš„è¯„ä»·ï¼š' + JSON.stringify(data.review, null, 2));
            } else {
                showResult('ç‚¹èµå¤±è´¥ï¼š' + data.message, true);
            }
        } catch (error) {
            showResult('ç‚¹èµå¤±è´¥ï¼š' + error.message, true);
        }
    }

    // 13. è¿½åŠ è¯„ä»·
    async function appendReview() {
        const reviewId = document.getElementById('manageReviewId').value;
        const userId = document.getElementById('buyerId').value || '1';

        if (!reviewId) {
            alert('è¯·è¾“å…¥è¯„ä»·ID');
            return;
        }

        const content = prompt('è¯·è¾“å…¥è¿½åŠ è¯„ä»·å†…å®¹ï¼š', 'ä½¿ç”¨ä¸€æ®µæ—¶é—´åï¼Œè´¨é‡ç¡®å®ä¸é”™ï¼Œå†æ¥è¿½è¯„ï¼');
        const images = prompt('è¯·è¾“å…¥è¿½åŠ å›¾ç‰‡URLï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œå¯é€‰ï¼‰ï¼š', '');

        if (!content) {
            alert('è¯·è¾“å…¥è¿½åŠ è¯„ä»·å†…å®¹');
            return;
        }

        const imageUrls = images ? images.split(',').map(url => url.trim()).filter(url => url) : [];

        try {
            const params = new URLSearchParams({
                parentReviewId: reviewId,
                userId
            });

            const url = `/api/review/append?${params.toString()}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: imageUrls.length > 0 ? JSON.stringify(imageUrls) : '[]'
            });

            const data = await response.json();

            if (data.success) {
                showResult('âœ… è¿½åŠ è¯„ä»·æˆåŠŸï¼\nè¿½åŠ è¯„ä»·ï¼š' + JSON.stringify(data.review, null, 2));
            } else {
                showResult('è¿½åŠ è¯„ä»·å¤±è´¥ï¼š' + data.message, true);
            }
        } catch (error) {
            showResult('è¿½åŠ è¯„ä»·å¤±è´¥ï¼š' + error.message, true);
        }
    }

    // 14. å›å¤è¯„ä»·
    async function replyToReview() {
        const reviewId = document.getElementById('manageReviewId').value;
        const respondentId = prompt('è¯·è¾“å…¥å›å¤è€…IDï¼ˆå–å®¶å›å¤ä¹°å®¶è¯„ä»·ï¼‰ï¼š', '3');
        const replyContent = prompt('è¯·è¾“å…¥å›å¤å†…å®¹ï¼š', 'æ„Ÿè°¢æ‚¨çš„è¯„ä»·ï¼Œæˆ‘ä»¬ä¼šç»§ç»­åŠªåŠ›ï¼');

        if (!reviewId || !respondentId || !replyContent) {
            alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
            return;
        }

        try {
            const response = await fetch(`/api/review/reply?reviewId=${reviewId}&respondentId=${respondentId}&replyContent=${encodeURIComponent(replyContent)}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                showResult('âœ… å›å¤æˆåŠŸï¼\næ›´æ–°åçš„è¯„ä»·ï¼š' + JSON.stringify(data.review, null, 2));
            } else {
                showResult('å›å¤å¤±è´¥ï¼š' + data.message, true);
            }
        } catch (error) {
            showResult('å›å¤å¤±è´¥ï¼š' + error.message, true);
        }
    }

    // 15. åˆ é™¤è¯„ä»·
    async function deleteReview() {
        const reviewId = document.getElementById('manageReviewId').value;
        const userId = prompt('è¯·è¾“å…¥ç”¨æˆ·IDï¼ˆç¡®è®¤åˆ é™¤ï¼‰ï¼š', '1');

        if (!reviewId || !userId) {
            alert('è¯·è¾“å…¥è¯„ä»·IDå’Œç”¨æˆ·ID');
            return;
        }

        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„ä»·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
            return;
        }

        try {
            const response = await fetch(`/api/review/${reviewId}?userId=${userId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                showResult('âœ… è¯„ä»·åˆ é™¤æˆåŠŸï¼');
            } else {
                showResult('åˆ é™¤è¯„ä»·å¤±è´¥ï¼š' + data.message, true);
            }
        } catch (error) {
            showResult('åˆ é™¤è¯„ä»·å¤±è´¥ï¼š' + error.message, true);
        }
    }

    // 16. è·å–çƒ­é—¨è¯„ä»·
    async function getHotReviews() {
        const productId = document.getElementById('viewProductId').value;

        if (!productId) {
            alert('è¯·è¾“å…¥å•†å“ID');
            return;
        }

        try {
            const response = await fetch(`/api/review/product/${productId}/hot?limit=5`);
            const data = await response.json();

            if (data.success) {
                showResult('çƒ­é—¨è¯„ä»·ï¼š\n' + JSON.stringify(data.hotReviews, null, 2));
            } else {
                showResult('è·å–çƒ­é—¨è¯„ä»·å¤±è´¥ï¼š' + data.message, true);
            }
        } catch (error) {
            showResult('è·å–çƒ­é—¨è¯„ä»·å¤±è´¥ï¼š' + error.message, true);
        }
    }

    // 17. è·å–å¸¦å›¾è¯„ä»·
    async function getReviewsWithImages() {
        const productId = document.getElementById('viewProductId').value;

        if (!productId) {
            alert('è¯·è¾“å…¥å•†å“ID');
            return;
        }

        try {
            const response = await fetch(`/api/review/product/${productId}/with-images?limit=5`);
            const data = await response.json();

            if (data.success) {
                showResult('å¸¦å›¾è¯„ä»·ï¼š\n' + JSON.stringify(data.reviewsWithImages, null, 2));
            } else {
                showResult('è·å–å¸¦å›¾è¯„ä»·å¤±è´¥ï¼š' + data.message, true);
            }
        } catch (error) {
            showResult('è·å–å¸¦å›¾è¯„ä»·å¤±è´¥ï¼š' + error.message, true);
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
    window.onload = function() {
        showResult('æ¬¢è¿ä½¿ç”¨åŒåŸå¿«å§è¯„ä»·ç³»ç»Ÿæµ‹è¯•ï¼\n\nè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æµ‹è¯•ï¼š\n1. äº†è§£è¯„ä»·ç±»å‹\n2. åˆ›å»ºå•†å“è¯„ä»·ï¼ˆéœ€è¦å·²å®Œæˆçš„è®¢å•ï¼‰\n3. æŸ¥çœ‹å•†å“è¯„ä»·å’Œç»Ÿè®¡\n4. ç®¡ç†è¯„ä»·ï¼ˆç‚¹èµã€è¿½åŠ ã€å›å¤ç­‰ï¼‰');

        // è‡ªåŠ¨è·å–è¯„ä»·ç±»å‹
        setTimeout(() => getReviewTypes(), 500);
    };
</script>
</body>
</html>